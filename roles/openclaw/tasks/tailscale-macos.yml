---
# macOS-specific Tailscale installation (open-source tailscaled via Homebrew formula)
#
# We use the open-source `tailscaled` variant (brew install --formula tailscale)
# instead of the GUI app (brew install --cask tailscale) because:
#   1. Tailscale SSH server — only available with tailscaled (zero-config SSH, no key management)
#   2. Tailscale Funnel — only available with tailscaled (stable public URLs for Twilio webhooks)
#   3. Runs before login — critical for headless Mac Minis after power outage
#   4. No GUI needed — these are headless servers
#
# Source: https://tailscale.com/kb/1065/macos-variants (comparison table)
# Source: https://github.com/tailscale/tailscale/wiki/Tailscaled-on-macOS

- name: Check if tailscaled (formula) is already installed
  ansible.builtin.command: /opt/homebrew/bin/tailscale version
  register: tailscale_formula_check
  changed_when: false
  failed_when: false

- name: Check if Tailscale GUI app exists (conflict check)
  ansible.builtin.stat:
    path: /Applications/Tailscale.app
  register: tailscale_gui_app

- name: Warn if GUI Tailscale app is installed
  ansible.builtin.debug:
    msg: |
      ⚠️  Tailscale GUI app detected at /Applications/Tailscale.app
      The GUI app conflicts with the open-source tailscaled daemon.
      Remove it before proceeding:
        rm -rf /Applications/Tailscale.app
        sudo rm -rf /Library/SystemExtensions/com.tailscale.ipn.macsys.network-extension.systemextension
      Then empty Trash and reboot.
  when: tailscale_gui_app.stat.exists

- name: Fail if GUI Tailscale app conflicts with tailscaled
  ansible.builtin.fail:
    msg: "Cannot install tailscaled while Tailscale.app is present. Remove /Applications/Tailscale.app first."
  when: tailscale_gui_app.stat.exists

- name: Install tailscaled via Homebrew formula (open-source variant)
  community.general.homebrew:
    name: tailscale
    state: present
  become: false
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
  when: tailscale_formula_check.rc != 0

- name: Ensure tailscaled state directory exists
  ansible.builtin.file:
    path: /var/lib/tailscale
    state: directory
    mode: "0755"
  become: true

- name: Ensure tailscaled socket directory exists
  ansible.builtin.file:
    path: /var/run/tailscale
    state: directory
    mode: "0755"
  become: true

- name: Start tailscaled daemon
  ansible.builtin.shell: |
    if ! pgrep -x tailscaled > /dev/null; then
      nohup /opt/homebrew/bin/tailscaled \
        --state=/var/lib/tailscale/tailscaled.state \
        --socket=/var/run/tailscale/tailscaled.sock \
        > /var/log/tailscaled.log 2>&1 &
      sleep 3
    fi
  become: true
  changed_when: true

- name: Wait for tailscaled to be ready
  ansible.builtin.command: tailscale --socket=/var/run/tailscale/tailscaled.sock status --json
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
  register: tailscale_status_macos
  changed_when: false
  failed_when: false
  retries: 15
  delay: 5
  until: tailscale_status_macos.rc == 0

- name: Connect to Tailnet with auth key (unattended)
  ansible.builtin.command: >
    tailscale --socket=/var/run/tailscale/tailscaled.sock up
    --ssh
    --authkey={{ tailscale_authkey }}
    --hostname={{ tailscale_hostname | default(ansible_hostname) }}
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
  become: true
  when: tailscale_authkey | length > 0
  no_log: true
  changed_when: true

- name: Connect to Tailnet interactively (no auth key)
  ansible.builtin.command: tailscale --socket=/var/run/tailscale/tailscaled.sock up --ssh
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
  become: true
  register: tailscale_up_result
  changed_when: true
  failed_when: false
  when: tailscale_authkey | length == 0

- name: Display manual Tailscale login instructions
  ansible.builtin.debug:
    msg:
      - "============================================"
      - "⚠️  Manual Tailscale login required"
      - "============================================"
      - ""
      - "tailscaled is running but not yet connected to your Tailnet."
      - ""
      - "After the playbook finishes, run:"
      - "  sudo tailscale up --ssh"
      - ""
      - "It will print a login URL. Open it in your browser to authenticate."
      - "Once connected, verify with: tailscale status"
      - ""
      - "For future deployments, generate an auth key at:"
      - "  https://login.tailscale.com/admin/settings/keys"
      - "Then pass it as: -e tailscale_authkey=tskey-auth-xxxxx"
  when: tailscale_authkey | length == 0

- name: Display Tailscale setup instructions
  ansible.builtin.debug:
    msg:
      - "============================================"
      - "Tailscale (open-source tailscaled) installed"
      - "============================================"
      - ""
      - "This is the CLI-only variant with full feature support:"
      - "  ✓ Tailscale SSH server (no SSH keys needed)"
      - "  ✓ Tailscale Funnel (stable public URLs)"
      - "  ✓ Runs before login (headless safe)"
      - ""
      - "To connect this Mac to your Tailnet:"
      - "  sudo tailscale up --ssh"
      - ""
      - "With auth key (unattended):"
      - "  sudo tailscale up --ssh --authkey tskey-auth-xxxxx"
      - ""
      - "To expose OpenClaw dashboard to your tailnet:"
      - "  tailscale serve --bg 18789"
      - ""
      - "To expose a port publicly (e.g. for Twilio webhooks):"
      - "  tailscale funnel --bg 3334"
      - ""
      - "Get auth key from: https://login.tailscale.com/admin/settings/keys"
  when: tailscale_authkey | length == 0
