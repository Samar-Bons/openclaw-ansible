---
# macOS-specific system hardening for dedicated OpenClaw Mac Minis
# Equivalent of firewall-linux.yml + unattended-upgrades for macOS

# Most tasks use changed_when: true because macOS `defaults` and `pmset` commands
# do not provide reliable idempotency detection — they succeed silently whether
# the value was already set or not.

# Energy & Sleep Settings (headless server)
- name: Prevent automatic sleeping
  ansible.builtin.command: pmset -a sleep 0
  become: true
  changed_when: true

- name: Prevent display sleep
  ansible.builtin.command: pmset -a displaysleep 0
  become: true
  changed_when: true

- name: Enable wake on network access
  ansible.builtin.command: pmset -a womp 1
  become: true
  changed_when: true

- name: Restart automatically after power failure
  ansible.builtin.command: pmset -a autorestart 1
  become: true
  changed_when: true

- name: Restart automatically if system freezes
  ansible.builtin.command: pmset -a restartfreeze 1
  become: true
  changed_when: true
  failed_when: false
  register: restartfreeze_result

- name: Note if restartfreeze is unsupported
  ansible.builtin.debug:
    msg: "pmset restartfreeze not supported on this macOS version (skipped)"
  when: restartfreeze_result.rc != 0

# Disable unnecessary services
- name: Disable AirDrop
  ansible.builtin.command: defaults write com.apple.NetworkBrowser DisableAirDrop -bool YES
  become: true
  changed_when: true

- name: Disable Bluetooth (headless server doesn't need it)
  ansible.builtin.command: defaults write /Library/Preferences/com.apple.Bluetooth ControllerPowerState -int 0
  become: true
  changed_when: true
  when: macos_disable_bluetooth | default(true) | bool

# Remote Access
# systemsetup -setremotelogin requires Full Disk Access on modern macOS,
# so we use launchctl to enable the SSH daemon directly.
- name: Enable SSH (Remote Login)
  ansible.builtin.command: launchctl load -w /System/Library/LaunchDaemons/ssh.plist
  become: true
  changed_when: true
  failed_when: false

# Disable macOS auto-updates (BlueBubbles can break on API changes)
- name: Disable automatic macOS updates
  ansible.builtin.command: defaults write /Library/Preferences/com.apple.SoftwareUpdate AutomaticDownload -bool false
  become: true
  changed_when: true

- name: Disable automatic macOS install
  ansible.builtin.command: defaults write /Library/Preferences/com.apple.SoftwareUpdate AutomaticallyInstallMacOSUpdates -bool false
  become: true
  changed_when: true

- name: Disable automatic app updates
  ansible.builtin.command: defaults write /Library/Preferences/com.apple.commerce AutoUpdate -bool false
  become: true
  changed_when: true

# Screen Sharing (VNC) for emergency access
- name: Enable Screen Sharing
  ansible.builtin.command: >
    /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart
    -activate -configure -access -on -restart -agent -privs -all -users {{ openclaw_user }}
  become: true
  changed_when: true
  when: macos_enable_screen_sharing | default(true) | bool

# Automatic login (required for headless operation)
- name: Enable automatic login for openclaw user
  ansible.builtin.command: >
    sysadminctl -autologin on
    -userName {{ openclaw_user }}
    -password "{{ openclaw_macos_password }}"
  become: true
  changed_when: true
  no_log: true
  when: macos_auto_login | default(true) | bool and openclaw_macos_password is defined

- name: Warn if auto-login skipped (password not set)
  ansible.builtin.debug:
    msg: >
      Auto-login was NOT configured because openclaw_macos_password is not set.
      Set openclaw_macos_password to enable automatic login.
  when: macos_auto_login | default(true) | bool and openclaw_macos_password is not defined

# FileVault (disk encryption)
- name: Check FileVault status
  ansible.builtin.command: fdesetup status
  register: filevault_status
  changed_when: false
  become: true

- name: Display FileVault status
  ansible.builtin.debug:
    msg: |
      FileVault status: {{ filevault_status.stdout }}
      ⚠️  If FileVault is not enabled, enable it manually:
        sudo fdesetup enable
      Save the recovery key securely (1Password recommended).
  when: "'FileVault is Off' in filevault_status.stdout"

- name: Warn about FileVault and auto-login conflict
  ansible.builtin.debug:
    msg: >
      FileVault is enabled but auto-login is also requested.
      FileVault requires a password at boot to unlock the disk, which conflicts
      with automatic login. Auto-login will only work after the FileVault
      unlock screen.
  when:
    - "'FileVault is On' in filevault_status.stdout"
    - macos_auto_login | default(true) | bool

# Keep Messages.app alive (critical for BlueBubbles)
- name: Create Scripts directory
  ansible.builtin.file:
    path: "{{ openclaw_home }}/Scripts"
    state: directory
    owner: "{{ openclaw_user }}"
    group: staff
    mode: '0755'

- name: Deploy poke-messages AppleScript
  ansible.builtin.copy:
    dest: "{{ openclaw_home }}/Scripts/poke-messages.scpt"
    owner: "{{ openclaw_user }}"
    group: staff
    mode: '0644'
    content: |
      try
        tell application "Messages"
          if not running then
            launch
          end if
          set _chatCount to (count of chats)
        end tell
      on error
      end try

- name: Ensure Library/Logs directory exists
  ansible.builtin.file:
    path: "{{ openclaw_home }}/Library/Logs"
    state: directory
    owner: "{{ openclaw_user }}"
    group: staff
    mode: '0755'

- name: Deploy poke-messages LaunchAgent
  ansible.builtin.copy:
    dest: "{{ openclaw_home }}/Library/LaunchAgents/com.sigil.poke-messages.plist"
    owner: "{{ openclaw_user }}"
    group: staff
    mode: '0644'
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
        <dict>
          <key>Label</key>
          <string>com.sigil.poke-messages</string>
          <key>ProgramArguments</key>
          <array>
            <string>/bin/bash</string>
            <string>-lc</string>
            <string>/usr/bin/osascript "{{ openclaw_home }}/Scripts/poke-messages.scpt"</string>
          </array>
          <key>RunAtLoad</key>
          <true/>
          <key>StartInterval</key>
          <integer>300</integer>
          <key>StandardOutPath</key>
          <string>{{ openclaw_home }}/Library/Logs/poke-messages.log</string>
          <key>StandardErrorPath</key>
          <string>{{ openclaw_home }}/Library/Logs/poke-messages.err</string>
        </dict>
      </plist>

- name: Unload poke-messages LaunchAgent (if already loaded)
  ansible.builtin.command: launchctl unload {{ openclaw_home }}/Library/LaunchAgents/com.sigil.poke-messages.plist
  become: true
  become_user: "{{ openclaw_user }}"
  changed_when: false
  failed_when: false

- name: Load poke-messages LaunchAgent
  ansible.builtin.command: launchctl load {{ openclaw_home }}/Library/LaunchAgents/com.sigil.poke-messages.plist
  become: true
  become_user: "{{ openclaw_user }}"
  changed_when: true
  register: launchctl_load_result
  failed_when: >
    launchctl_load_result.rc != 0 and
    'already loaded' not in (launchctl_load_result.stderr | default(''))

- name: Display macOS hardening summary
  ansible.builtin.debug:
    msg: |
      ✅ macOS hardening applied:
        • Sleep disabled, wake on network enabled
        • Auto-restart on power failure enabled
        • AirDrop disabled
        • SSH enabled
        • macOS auto-updates disabled (protect BlueBubbles)
        • Messages.app keep-alive LaunchAgent installed
        {{ '• Screen Sharing enabled' if macos_enable_screen_sharing | default(true) else '' }}
        {{ '• Automatic login enabled for ' + openclaw_user if macos_auto_login | default(true) else '' }}
        {{ '• Bluetooth disabled' if macos_disable_bluetooth | default(true) else '' }}
